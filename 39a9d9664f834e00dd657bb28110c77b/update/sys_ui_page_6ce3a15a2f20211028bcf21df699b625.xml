<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ui_page">
    <sys_ui_page action="INSERT_OR_UPDATE">
        <category>general</category>
        <client_script>jQuery(function () {
  var $ = jQuery;
  var modal = GlideModal.get();
  var snIncidentId = modal.getPreference('snIncidentId');
  var loading = false;
  var userId = g_user.userID;

  var api = x_pd_integration.AjaxHelper.ajaxClientFor('IncidentWorkflowController');
  var trackingApi = x_pd_integration.AjaxHelper.ajaxClientFor('TrackingController');

  var pdIncidentId = g_form.getValue('x_pd_integration_incident');
  var noWorkflowsMessage = '&lt;b&gt;No workflows were found in PagerDuty for the incident \'' + pdIncidentId + '\'.&lt;/b&gt;';

  var learnLink = '&lt;a href="https://support.pagerduty.com/docs/incident-workflows' +
    '?utm_source=servicenow_itsm&amp;utm_content=run_workflow_dialog_no_options" ' +
    'target="_blank" rel="noopener noreferrer"&gt;Learn how to create a workflow in PagerDuty&lt;/a&gt;';

  var notAuthorizedMessage = '&lt;b&gt;Your user is not authorized to run workflows&lt;/b&gt;&lt;br&gt;';
  var learnPermissionsLink = '&lt;a href="https://www.pagerduty.com/resources/learn/user-roles-permissions/' +
    '?utm_source=servicenow_itsm&amp;utm_content=run_workflow_dialog_permission_error"' +
    ' target="_blank" rel="noopener noreferrer"&gt;Learn more about user permissions in PagerDuty&lt;/a&gt;';

  var firstReceivedItems = {};
  api.fetchIncidentWorkflows(userId, snIncidentId, function (error, data) {
    firstReceivedItems = data;
    var errorMessage = extractErrorMessage(error, data);
    if (errorMessage) {
      fail(errorMessage);
      return;
    }
    api.isEligibleRunIW(userId, snIncidentId, function (error, result) {
      if (error) {
        jslog('Workflow Run: is Eligible to Run IW check error. ' + JSON.stringify(error, null, 2));
      }
      if (result) {
        showIWSelector();
      } else {
        fail(notAuthorizedMessage + learnPermissionsLink);
      }
    });
  });

  var incidentWorkflowSelector = new x_pd_integration.PdSelect({
    element: document.querySelector('.pd-workflow-selector'),
    initValues: function () {
      var bodyInput = $('.pds-body input');
      bodyInput.attr('disabled', 'disabled');
      bodyInput.attr('readonly', 'readonly');
    },
    load: function (text, callback) {
      if (hasValues(firstReceivedItems)) {
        callback(firstReceivedItems);
        firstReceivedItems = {};
      } else {
        api.fetchIncidentWorkflows(userId, snIncidentId, function (error, data) {
          var errorMessage = extractErrorMessage(error, data);
          if (errorMessage) {
            fail(errorMessage);
            return;
          }
          callback(data);
        });
      }
    },
    onUpdate: function (selectionId) {
      var submitElement = document.querySelector('button.btn.submit-request');
      if (selectionId) {
        submitElement.classList.remove('disabled');
      } else {
        submitElement.classList.add('disabled');
      }
    }
  });

  var submitElement = $('.pd-workflow-form button.submit-request');
  submitElement.on('click', function (event) {
    event.preventDefault();
    event.stopPropagation();
    if (loading) {
      return;
    }
    loading = true;
    trackingApi.track('run_workflow_dialog_clicked_submit_request_button', {}, function (error, _result) {
      if (error) {
        jslog('Tracking error: ' + error);
      }
    });

    submitElement.attr('disabled', true);
    submitElement.html('&lt;span class="icon icon-loading"&gt;&lt;/span&gt; Running...');

    var incidentWorkflowId = incidentWorkflowSelector.getSelectionData().id;
    var incidentWorkflowName = incidentWorkflowSelector.getSelectionData().name;

    api.runIncidentWorkflow(snIncidentId, userId, incidentWorkflowId, incidentWorkflowName, function (error, result) {
      if (error) {
        jslog(error.stack);
        var message = error.message || 'Error: ' + JSON.stringify(error);
        g_form.addErrorMessage('Error triggering a workflow "' + incidentWorkflowName + '". ' + message);
      } else {
        g_form.addInfoMessage(result.message);
      }
      modal.destroy();
    });
  });

  $('.pd-workflow-form button.submit-cancel').on('click', function (event) {
    event.preventDefault();
    event.stopPropagation();
    trackingApi.track(
      'run_workflow_dialog_clicked_cancel_button', {},
      function (error, _result) {
        if (error) {
          jslog('Tracking error: ' + error);
        }
      }
    );
    modal.destroy();
  });

  function extractErrorMessage (error, data) {
    var errorMessage = '';

    if (error) {
      jslog(error);
      errorMessage = error.message || 'Error: ' + JSON.stringify(error);
      return errorMessage;
    }

    if (data.errorMessage) {
      var middleMessage = data.errorMessage;
      // eslint-disable-next-line es5/no-es6-methods
      if (data.errorMessage.includes('Incident \'' + pdIncidentId + '\' not found')) {
        middleMessage = 'The incident \'' + pdIncidentId + '\' doesn\'t exist in PagerDuty.';
      }
      errorMessage = [noWorkflowsMessage, middleMessage, learnLink].join('&lt;br&gt;');
      return errorMessage;
    }

    if (data.items.length === 0) {
      errorMessage = [noWorkflowsMessage, learnLink].join('&lt;br&gt;');
      return errorMessage;
    }

    return errorMessage;
  }
});

function fail (message) {
  var modal = GlideModal.get();
  g_form.addErrorMessage(message);
  modal.destroy();
}

function showIWSelector () {
  document.querySelector('.pds-body input').removeAttribute('disabled');
  document.querySelector('.pds-body input').removeAttribute('readonly');
  document.querySelector('.pd-workflow-form .pd-message').style.visibility = 'hidden';
  document.querySelector('.pd-workflow-form .form-group').style.visibility = 'visible';
}

function hasValues (obj) {
  return Object.keys(obj).length &gt; 0;
}
</client_script>
        <description>Show a PagerDuty "Run a Workflow" Dialog</description>
        <direct>false</direct>
        <endpoint>x_pd_integration_run_workflow_dialog.do</endpoint>
        <html>&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;j:jelly trim="false" xmlns:j="jelly:core" xmlns:g="glide" xmlns:j2="null" xmlns:g2="null"&gt;
  &lt;g:evaluate var="jvar_stamp" expression="new Date().getTime()" /&gt;
  &lt;script language="javascript" src="x_pd_integration.AjaxHelper.jsdbx?v=${HTML:jvar_stamp}"&gt;&lt;/script&gt;
  &lt;script language="javascript" src="x_pd_integration.PdSelect.jsdbx?v=${HTML:jvar_stamp}"&gt;&lt;/script&gt;

  &lt;g:evaluate&gt;
    var pdLogo = gs.getProperty('x_pd_integration.pd_logo');
  &lt;/g:evaluate&gt;

  &lt;style&gt;
    .form_body {
      background-color: #fff;
    }
    .pd-message {
      height: 2rem;
      text-align: center;
    }
    .pd-workflow-form {
      margin: 1rem;
    }
    .submit-cancel, .submit-request {
      width: 10rem;
    }
  &lt;/style&gt;

  &lt;form class="form_body form-horizontal pd-workflow-form"&gt;
    &lt;div class="row"&gt;
      &lt;div class="col-sm-12"&gt;
        &lt;p class="pd-message"&gt;&lt;span class="icon icon-loading"&gt;&lt;/span&gt;&lt;/p&gt;
        &lt;div class="form-group" style="visibility: hidden;"&gt;
          &lt;label class="col-xs-12 col-md-3 col-lg-4 control-label" for="pds-input" style="padding: 0.75rem 0;"&gt;
            &lt;span class="label-text"&gt;Select a Workflow&lt;/span&gt;
          &lt;/label&gt;
          &lt;div class="col-xs-10 col-sm-9 col-md-6 col-lg-5 form-field pd-workflow-selector"&gt;
            &lt;div class="input-group ref-container"&gt;
              &lt;input value="" class="form-control element_reference_input" /&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class="row" style="margin-top: 19rem"&gt;
      &lt;div class="col-sm-12"&gt;
        &lt;div class="pull-left" style="padding: 6px 9px;"&gt;
          &lt;img width="120" alt="PagerDuty Logo" src="${HTML:pdLogo}" /&gt;
        &lt;/div&gt;
        &lt;div class="pull-right"&gt;
          &lt;button class="btn btn-default submit-cancel" style="margin-right: 1rem"&gt;Cancel&lt;/button&gt;
          &lt;button class="btn btn-primary submit-request disabled"&gt;Run&lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/form&gt;
&lt;/j:jelly&gt;
</html>
        <name>run_workflow_dialog</name>
        <processing_script/>
        <sys_class_name>sys_ui_page</sys_class_name>
        <sys_created_by>PagerDuty_v8.0</sys_created_by>
        <sys_created_on>2023-01-24 15:45:59</sys_created_on>
        <sys_id>6ce3a15a2f20211028bcf21df699b625</sys_id>
        <sys_mod_count>2</sys_mod_count>
        <sys_name>run_workflow_dialog</sys_name>
        <sys_package display_value="PagerDuty Incident Resolution Platform" source="x_pd_integration">39a9d9664f834e00dd657bb28110c77b</sys_package>
        <sys_policy/>
        <sys_scope display_value="PagerDuty Incident Resolution Platform">39a9d9664f834e00dd657bb28110c77b</sys_scope>
        <sys_update_name>sys_ui_page_6ce3a15a2f20211028bcf21df699b625</sys_update_name>
        <sys_updated_by>PagerDuty_v8.0</sys_updated_by>
        <sys_updated_on>2023-09-29 14:39:44</sys_updated_on>
    </sys_ui_page>
</record_update>
