<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_transform_map">
    <sys_transform_map action="INSERT_OR_UPDATE">
        <active>true</active>
        <copy_empty_fields>false</copy_empty_fields>
        <enforce_mandatory_fields>No</enforce_mandatory_fields>
        <name>PagerDuty Note Import</name>
        <order>100</order>
        <run_business_rules>true</run_business_rules>
        <run_script>true</run_script>
        <script>/**
 * For variables go to: http://wiki.service-now.com/index.php?title=Import_Sets
 **/

importPDNote();

function importPDNote () {
  //don't create incidents from missing pagerduty id
  if (action == 'insert') {
    ignore = true;
    return;
  }


  var existingNoteIDs = target.getValue('x_pd_integration_notes_ids');
  var sourceNoteID = source.getValue('note_id');
  var content = source.getValue('content');
  var userID = source.getValue('user_id');
  var userName = source.getValue('user_name');

  if (userName == 'undefined' &amp;&amp; !gs.nil(userID)) {
	    gs.debug('importPDNote: Find User Name');
    var pd = new x_pd_integration.PagerDuty();
    var name = pd.getUserNameByPDID(userID);
    if (!gs.nil(name)) {
      userName = name;
    }
  }
  gs.debug('importPDNote: User Name={0}', userName);

  //add worknote to incident if we don't have it yet
  if (gs.nil(existingNoteIDs) || existingNoteIDs.indexOf(sourceNoteID) == -1) {
    if (!gs.nil(existingNoteIDs)) {
      var updatedNotesIDs = existingNoteIDs + ',' + sourceNoteID;
    } else {
      var updatedNotesIDs = sourceNoteID;
    }
    target.work_notes = x_pd_integration.WorkNotesHelper.build(content + '  (PagerDuty:' + userName + ' on ' + source.getValue('note_created_at') + ')');
    target.setValue('x_pd_integration_notes_ids', updatedNotesIDs);
    gs.debug('Updated note and note date on {0}', target.getDisplayValue());
  } else {
    status_message = 'imported note already exists';
    ignore = true;
  }
}
</script>
        <source_table>x_pd_integration_inc_note_import</source_table>
        <sys_class_name>sys_transform_map</sys_class_name>
        <sys_created_by>PagerDuty_v8.0</sys_created_by>
        <sys_created_on>2016-03-29 00:54:46</sys_created_on>
        <sys_id>a56fbc444fae9a00dd657bb28110c75f</sys_id>
        <sys_mod_count>34</sys_mod_count>
        <sys_name>PagerDuty Note Import</sys_name>
        <sys_package display_value="PagerDuty Incident Resolution Platform" source="x_pd_integration">39a9d9664f834e00dd657bb28110c77b</sys_package>
        <sys_policy/>
        <sys_scope display_value="PagerDuty Incident Resolution Platform">39a9d9664f834e00dd657bb28110c77b</sys_scope>
        <sys_update_name>sys_transform_map_a56fbc444fae9a00dd657bb28110c75f</sys_update_name>
        <sys_updated_by>PagerDuty_v8.0</sys_updated_by>
        <sys_updated_on>2017-04-07 22:04:01</sys_updated_on>
        <target_table>incident</target_table>
    </sys_transform_map>
</record_update>
