<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_pd_integration.Services</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Refreshes all Services from PagerDuty API to ServiceNow table [x_pd_integration_services].</description>
        <name>Services</name>
        <script>/*** Changes made to this script are not supported by PagerDuty ***/
var Services = Class.create();
Services.prototype = {
  initialize: function() {},
  type: 'Services',

  refreshServices: function() {
    var rest = new x_pd_integration.PagerDuty_REST();
    var fetchedItems = rest.getAllItems('services', transformItem);

    if (rest.hasError())
      return { error: rest.getError(), message: '' };

    if (!fetchedItems.length)
      return { error: '', message: 'No services were fetched from PagerDuty' };

    var storedItems = getStoredItems('x_pd_integration_services', 'service_id');
    upsertServices(fetchedItems);
    var staleItems = subtract(storedItems, fetchedItems, 'service_id');
    inactivate('x_pd_integration_services', 'service_id', staleItems);

    return { error: '', message: 'Refreshed services from PagerDuty' };
  }
};

var transformItem = function(item) {
  var subdomain = '';
  if (item.html_url) {
    subdomain = item.html_url.split('://').slice(-1)[0].split('.')[0];
  }
  return {
    active: true,
    service_id: item.id,
    service_name: item.name,
    subdomain: subdomain,
  };
};

var getStoredItems = function(tableName, fieldName) {
  var records = {};
  var rec = new GlideRecordSecure(tableName);
  rec.query();
  while (rec.next()) {
    if (rec[fieldName])
      records[rec[fieldName].toString()] = { active: rec.active.toString() };
  }
  return records;
};

var upsertServices = function(services) {
  services.forEach(function(ep) {
    var rec = new GlideRecordSecure('x_pd_integration_services_import');
    rec.initialize();
    rec.active = ep.active;
    rec.service_id = ep.service_id;
    rec.service_name = ep.service_name;
    rec.subdomain = ep.subdomain;
    rec.insert();
  });
};

var subtract = function(storedItems, fetchedItems, fieldName) {
  var staleItems = JSON.parse(JSON.stringify(storedItems));
  fetchedItems.forEach(function(fetchedObject) {
    if (staleItems[fetchedObject[fieldName]])
      delete staleItems[fetchedObject[fieldName]];
  });
  return staleItems;
};

var inactivate = function(tableName, fieldName, staleItems) {
  Object.keys(staleItems).forEach(function(id) {
    var rec = new GlideRecordSecure(tableName);
    rec.addQuery(fieldName, id);
    rec.query();
    while (rec.next()) {
      if (rec.active) {
        rec.active = false;
        rec.update();
      }
    }
  });
};
</script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>PagerDuty_v8.0</sys_created_by>
        <sys_created_on>2020-05-13 12:41:48</sys_created_on>
        <sys_id>c7b84b30077450109f3bff1d7c1ed012</sys_id>
        <sys_mod_count>4</sys_mod_count>
        <sys_name>Services</sys_name>
        <sys_package display_value="PagerDuty Incident Resolution Platform" source="x_pd_integration">39a9d9664f834e00dd657bb28110c77b</sys_package>
        <sys_policy/>
        <sys_scope display_value="PagerDuty Incident Resolution Platform">39a9d9664f834e00dd657bb28110c77b</sys_scope>
        <sys_update_name>sys_script_include_c7b84b30077450109f3bff1d7c1ed012</sys_update_name>
        <sys_updated_by>PagerDuty_v8.0</sys_updated_by>
        <sys_updated_on>2021-05-12 15:02:46</sys_updated_on>
    </sys_script_include>
</record_update>
