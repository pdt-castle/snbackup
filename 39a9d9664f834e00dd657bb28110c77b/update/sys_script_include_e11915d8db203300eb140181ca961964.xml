<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_pd_integration.AjaxHelper</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <name>AjaxHelper</name>
        <script>/*** Changes made to this script are not supported by PagerDuty ***/
var AjaxHelper = {
  createAjaxController: function createAjaxController (definition) {
    var controller = Class.create();
    controller.prototype = Object.extendsObject(global.AbstractAjaxProcessor, {
      type: definition.type,

      dispatch: function dispatch () {
        var targetName = this.getParameter('sysparm_json_name');
        var strArgument = this.getParameter('sysparm_json_argument');
        try {
          var args = JSON.parse(strArgument);
          if (!definition[targetName]) {
            return JSON.stringify({
              error: {
                message: 'method ' + targetName + ' is not found in the Controller ' + definition.type
              }
            });
          }
          var data = definition[targetName].apply(definition, args);
          var str = JSON.stringify({result: data});
          var result = this.sanitize(str);
          return result;
        } catch (e) {
          gs.error('Error calling {0}:{1} =&gt; {2}', definition.type, targetName, e.message);
          return JSON.stringify({error: {message: e.message, stack: e.stack}});
        }
      },

      sanitize: function (str) {
        if (this.shouldRemoveEmojis()) {
          str = this.removeEmojis(str);
        }
        return str;
      },

      shouldRemoveEmojis: function () {
        var buildtag = '';
        var gr = new GlideRecord('sys_properties');
        gr.addQuery('name', 'glide.buildtag.last');
        gr.query();
        if (gr.next()) {
          buildtag = gr.getValue('value');
        }

        // example: glide-orlando-12-11-2019__patch5-06-17-2020
        var match = buildtag.match(/^glide-[a-z]*(?=-\d{2})/i);
        var release;
        if (match) {
          release = match[0].split('-')[1];
        }
        if (!release) {
          return true;
        }

        // in the 'paris' version and above, emojis are handled properly
        var legacy = ['madrid', 'newyork', 'orlando'];
        if (legacy.indexOf(release) &gt;= 0) {
          return true;
        }
        return false;
      },

      removeEmojis: function (str) {
        var regex = /(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|[\ud83c\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|[\ud83c\ude32-\ude3a]|[\ud83c\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/g;
        str = str.replace(regex, '').replace(/\s{2,}/g, ' ');
        return str;
      }

    });

    return controller;
  }
};
</script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>PagerDuty_v8.0</sys_created_by>
        <sys_created_on>2019-03-28 12:32:37</sys_created_on>
        <sys_id>e11915d8db203300eb140181ca961964</sys_id>
        <sys_mod_count>45</sys_mod_count>
        <sys_name>AjaxHelper</sys_name>
        <sys_package display_value="PagerDuty Incident Resolution Platform" source="x_pd_integration">39a9d9664f834e00dd657bb28110c77b</sys_package>
        <sys_policy/>
        <sys_scope display_value="PagerDuty Incident Resolution Platform">39a9d9664f834e00dd657bb28110c77b</sys_scope>
        <sys_update_name>sys_script_include_e11915d8db203300eb140181ca961964</sys_update_name>
        <sys_updated_by>PagerDuty_v8.0</sys_updated_by>
        <sys_updated_on>2020-10-12 13:51:37</sys_updated_on>
    </sys_script_include>
</record_update>
